<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>ONIROS IPS</title>
  <link rel="stylesheet" href="styles.css">

  <!-- LIBRER√çAS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://kit.fontawesome.com/a6af6903e9.js" crossorigin="anonymous"></script>
</head>
<body>
<div class="wrap-visor">
    <div class="visor">
  <div id="wrapper" class="scale-wrapper">
    <div class="hoja-carta">

      <div class="logo-wrap">
        <img alt="Logo ONIROS IPS">
      </div>
        <h2>CONSENTIMIENTO</h2>
        <p>
            <b>ONIROS SAS.</b> le realizar√° a usted esta noche el examen denominado <b>POLISOMNOGRAMA,</b> el cual consiste en un registro con una serie de se√±ales fisiol√≥gicas como son la actividad cerebral, el movimiento de los ojos, el ritmo cardiaco, la respiraci√≥n, el ronquido, la actividad muscular y la cantidad de ox√≠geno en sangre (saturaci√≥n de ox√≠geno), con el cual permitir√° diagnosticar posibles alteraciones durante el sue√±o, como son la presencia de pausas respiratorias (apneas-hipopneas), ronquido, posibles arritmias, desaturaci√≥n de ox√≠geno, bruxismo, movimientos de las piernas y otras alteraciones. 
        </p>
        <p>
            Con usted estar√° toda la noche con un personal altamente calificado y entrenado (t√©cnico de sue√±o-auxiliar de enfermer√≠a), para resolver cualquier inquietud que usted tenga acerca de la realizaci√≥n del examen y las posibles necesidades que se presenten en la noche.
        </p>
        <p>
            Usted est√° asistiendo al excamen denominado <b>POLISOMNOGRAMA CON TITULACI√ìN DE PAP,</b> la logistica es muy parecida/similar al primer estudio, la prueba con oximetria. En este examen a usted le colocaran una m√°scara y un equipo de <b>presi√≥n positiva</b> (la t√©cnica de sue√±o se los mostrar√° y explicar√°) que ayudar√° a encontrar la presi√≥n terap√©utica con la cual corregir√°n los eventos respiratorios anormales (apena - hipopneas) que le detectaron con el polisomnogrma de diagn√≥stico.
        </p>
        <p>
            Para estos ex√°menes se hacen unas series de conexiones con electrodos (<b><u>no invasivos y no el√©ctricos</u></b>) en la cabeza, cara y piernas con la ayuda de una crema conductora (<b>crema que es aplicada con cuidado para evitar irritaci√≥n en sus ojos</b> - el tecnico est√° altamente capacitado y entrenado para la aplicaci√≥n de esta crema y le dar√° la informaci√≥n desde el inicio que <b><u>no se frote los ojos</u></b>); igualmente, le conectar√°n unos cinturones el√°sticos en t√≥rax y abdomen, unos electrodos de electrocardiograma y otros sensores como son los de posici√≥n, oximetr√≠a y micr√≥fono. Le colocar√°n una c√°nula de ox√≠geno en la cara.
        </p>
        <p>
            El t√©cnico de sue√±o le explicar√° para qu√© es cada uno de los cables que se le van a conectar, le mostrar√° su cuestionario de s√≠ntomas relacionados con su sue√±o y le har√° unas preguntas cortas de su historia cl√≠nica, el cual ser√° confidencial y muy importante para la correlaci√≥n con los resultados de este examen.
        </p>
        <p>
            La habitaci√≥n destinada para este examen cumple con las indicaciones est√°ndar de comodidad, silencio y privacidad. Consta de una cama con un juego de cama y cobijas limpias y una mesa de noche. El t√©cnico de sue√±o se encontrar√° en un sal√≥n de monitoreo que estar√° cerca de su habitaci√≥n y tendr√° ayuda de un video para estar m√°s pendiente de usted y de su llamado. El ba√±o se encuentra fuera de la habitaci√≥n, cumpliendo con uno de los requisitos de la Academia de Sue√±o.
        </p>
        <p>
            Para el estudio de titulaci√≥n, el t√©cnico le colocar√°  el equipo de PAP un tiempo determinado para que usted conozca, sienta, y se adapte al aire que sale del equipo a trav√©s de una mascara que estara en su cara, este per√≠odo se llama adaptaci√≥n al equipo y mascara. De acuerdo a la buena tolerancia que usted refiera, el t√©cnico <b>iniciar√° el estudio,</b> estara pendiente de usted y le aclarar√° posibles dudas que tenga acerca del equipo.  
        </p>
        <p>
            Teniendo claridad en lo antes escrito e informado por el personal responsable de <b>ONIROS SAS.</b> 
            Yo, <span id="firma1" class="firma-enlinea" onclick="abrirModal(1)"></span> identificado(a) con la c√©dula No. <span id="firma2" class="firma-enlinea" onclick="abrirModal(2)"></span> de <span id="firma3" class="firma-enlinea" onclick="abrirModal(3)"></span>, acept√≥ la realizaci√≥n del servicio conocido como
        </p>

      <!-- TABLA -->
      <table border="1">
        <tr>
          <th>POLISOMNOGRAFIA CON OXIMETRIA</th>
          <th>POLISOMNOGRAMA PAP</th>
          <th>NOCHE PARTIDA</th>
          <th>LATENCIAS</th>
        </tr>
        <tr>
          <td></td>
          <td><b>X</b></td><td></td><td></td>
        </tr>
      </table>
      <p>
            y hago constar que me han explicado en qu√© consiste el examen y cu√°l es su finalidad de quedarme una noche en la cl√≠nica.
            </p>

      <!-- FECHA -->
      <div class="fechaExamenInput">
        <label><b>Fecha del examen:</b></label>
        <input id="fakeDate" class="date-display" readonly>
      </div>

      <!-- FIRMAS -->
      <div>
        <label><b>Firma del paciente:</b></label>
        <span id="firma4" class="firma-enlinea" onclick="abrirModalDibujo(4)"></span>
      </div>

      <div>
        <label><b>Identificaci√≥n No.:</b></label>
        <span id="firma5" class="firma-enlinea" onclick="abrirModal(5)"></span>
      </div>

      <div class="firmaTestigoInput">
        <div class="firma-pair">
            <label><b>Firma del acompa√±ante o responsable:</b></label>
            <span id="firma6" class="firma-enlinea" onclick="abrirModalDibujo(6)"></span>
        </div>

        <div class="firma-pair">
            <label><b>Identificaci√≥n No.:</b></label>
            <span id="firma7" class="firma-enlinea" onclick="abrirModal(7)"></span>
        </div>
    </div>
    </div>
  </div>
</div>
</div>


<!-- MODAL TEXTO -->
<div id="modal" class="modal">
  <div class="modal-contenido">
    <h3 id="modalTitle">Escribe tu nombre</h3>
    <input id="firmaTexto" type="text" placeholder="Escribe Aqu√≠">
    <button onclick="guardarFirma()">Aceptar</button>
    <button onclick="cerrarModal()">Cancelar</button>
  </div>
</div>
<!-- MODAL √âXITO -->
<div id="modalExito" class="modal">
  <div class="modal-contenido modal-exito">
    <h3>‚úî Documento generado</h3>
    <p>El consentimiento fue descargado correctamente.</p>
    <button onclick="cerrarModalExito()">Aceptar</button>
  </div>
</div>


<!-- MODAL DIBUJO -->
<div id="modalDibujo" class="modal">
  <div class="modal-contenido">
    <h3 id="modalDibujoTitle">Firma aqu√≠</h3>
    <canvas id="canvasFirma" width="300" height="150"></canvas>
    <br>
    <button onclick="limpiarCanvas()">Limpiar</button>
    <button onclick="guardarFirmaDibujo()">Aceptar</button>
    <button onclick="cerrarModalDibujo()">Cancelar</button>
  </div>
</div>
<div class="btn-wrap">
    <button class="btnDescargarPDF" onclick="descargarPDF()">
        Terminar <i class="fa-solid fa-check"></i>
    </button>
</div>

<!-- LOADER SPINNER -->
 <div id="loaderWrap"class="loader-wrap">
  <div  class="loader"></div>
  <h3>Generando Consentimiento, por favor espere.</h3>
 </div>



<script src="logoBase64.js"></script>
<script>
    let firmaActual = null;
let firmaActualDibujo = null;
let modalCampo = null;

const firmasNumericas = [2,5,7];

let canvas, ctx;
let dibujando = false;

document.addEventListener("DOMContentLoaded", () => {
     document.querySelector(".logo-wrap img").src = LOGO_BASE64;

  // FECHA
  const hoy = new Date();
  const fechaInput = document.getElementById("fakeDate");

  fechaInput.value = hoy.toLocaleDateString("es-CO");
  fechaInput.classList.add("date-filled"); // üëà AQU√ç

  // CANVAS (AQU√ç S√ç EXISTE)
  canvas = document.getElementById("canvasFirma");
  ctx = canvas.getContext("2d");

  

  canvas.addEventListener("mousedown", e => {
    dibujando = true;
    ctx.beginPath();
    ctx.moveTo(e.offsetX, e.offsetY);
  });

  canvas.addEventListener("mousemove", e => {
    if (!dibujando) return;
    ctx.lineWidth = 2;
    ctx.lineCap = "round";
    ctx.lineTo(e.offsetX, e.offsetY);
    ctx.stroke();
  });

  canvas.addEventListener("mouseup", () => dibujando = false);

  // ==== SOPORTE TOUCH (TABLET / CELULAR) ====

canvas.addEventListener("touchstart", e => {
  e.preventDefault();
  const touch = e.touches[0];
  const rect = canvas.getBoundingClientRect();

  dibujando = true;
  ctx.beginPath();
  ctx.moveTo(
    touch.clientX - rect.left,
    touch.clientY - rect.top
  );
}, { passive: false });

canvas.addEventListener("touchmove", e => {
  if (!dibujando) return;
  e.preventDefault();

  const touch = e.touches[0];
  const rect = canvas.getBoundingClientRect();

  ctx.lineWidth = 2;
  ctx.lineCap = "round";
  ctx.lineTo(
    touch.clientX - rect.left,
    touch.clientY - rect.top
  );
  ctx.stroke();
}, { passive: false });

canvas.addEventListener("touchend", e => {
  e.preventDefault();
  dibujando = false;
});


  // ESCALA
  const wrapper = document.getElementById("wrapper");
function ajustarEscala() {
  const wrapper = document.getElementById("wrapper");

  const hojaAncho = 850;
  const hojaAlto = 1200;

  const anchoViewport = window.innerWidth;
  const altoViewport = window.innerHeight;

  // m√°rgenes de seguridad
  const margenX = 20;
  const margenY = 40;

  const escalaX = (anchoViewport - margenX) / hojaAncho;
  const escalaY = (altoViewport - margenY) / hojaAlto;

  let scale;

  // üëâ tablets suelen fallar por altura, priorizamos alto
  if (anchoViewport >= 768 && anchoViewport <= 1024) {
    scale = Math.min(escalaY, 1);
  } else {
    scale = Math.min(escalaX, escalaY, 1);
  }

  // seguridad
  scale = Math.max(scale, 0.4);

  wrapper.style.transform = `scale(${scale})`;
}


  ajustarEscala();
  window.addEventListener("resize", ajustarEscala);
});


function abrirModal(num) {
  firmaActual = document.getElementById("firma" + num);
  modalCampo = num;

  const input = document.getElementById("firmaTexto");
  input.value = "";

  // üëâ CAMBIAR T√çTULO
  document.getElementById("modalTitle").textContent =
    titulosModal[num] || "Ingrese el dato";

  document.getElementById("modal").style.display = "flex";
}



function cerrarModal() {
  document.getElementById("firmaTexto").value = "";
  document.getElementById("modal").style.display = "none";
}


function guardarFirma() {
  const input = document.getElementById("firmaTexto");
  const texto = input.value.trim();

  if (firmasNumericas.includes(modalCampo) && !/^\d+$/.test(texto)) {
    alert("Porfavor solo se aceptan numeros, sin letras, caracteres especiales o espacios");
    return;
  }

  firmaActual.textContent = texto;
  firmaActual.classList.add("firma-finalizada");
  cerrarModal();
}

function abrirModalDibujo(num) {
  const campo = document.getElementById("firma" + num);

  if (campo.classList.contains("firma-finalizada")) return;

  firmaActualDibujo = campo;
  limpiarCanvas();

  document.getElementById("modalDibujoTitle").textContent =
    titulosModalDibujo[num] || "Firma";

  document.getElementById("modalDibujo").style.display = "flex";
}

function cerrarModalDibujo() {
  limpiarCanvas();
  document.getElementById("modalDibujo").style.display = "none";
}


function limpiarCanvas() {
  ctx.clearRect(0,0,canvas.width,canvas.height);
}

function guardarFirmaDibujo() {
  const img = document.createElement("img");
  img.src = canvas.toDataURL("image/png");
  img.style.height = "55px";
  img.classList.add("imagen-firma");

  firmaActualDibujo.innerHTML = "";
  firmaActualDibujo.appendChild(img);

  // üëâ CAMBIAR ESTILO A "FINALIZADO"
  firmaActualDibujo.classList.add("firma-finalizada");

  cerrarModalDibujo();
}

async function descargarPDF() {
  mostrarLoader(); // mostrar spinner

  const wrapper = document.getElementById("wrapper");
  const area = document.querySelector(".hoja-carta");

  // guardar scale original y quitar scale temporal
  const scaleOriginal = wrapper.style.transform;
  wrapper.style.transform = "scale(1)";

  // peque√±o delay para que el navegador aplique estilos antes de capturar
  await new Promise(resolve => setTimeout(resolve, 50));

  // generar canvas a alta resoluci√≥n
  const canvas = await html2canvas(area, { scale: 4, useCORS: true });
  const imgData = canvas.toDataURL("image/png");

  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF("p", "mm", "letter");

  const pdfWidth = pdf.internal.pageSize.getWidth();
  const imgProps = pdf.getImageProperties(imgData);
  const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

  pdf.addImage(imgData, "PNG", 0, 0, pdfWidth, pdfHeight);

  const nombre = document.getElementById("firma1").textContent.trim();
  const id = document.getElementById("firma2").textContent.trim();
  const nombreArchivo = `consentimiento-informado_ID${id}_${nombre.replace(/\s+/g, "_")}.pdf`;

  pdf.save(nombreArchivo);

  // restaurar scale original
  wrapper.style.transform = scaleOriginal;

  ocultarLoader(); // ocultar spinner
  window.location.href = "exito.html"; // reemplaza con la URL que quieras
}




function mostrarModalExito() {
  document.getElementById("modalExito").style.display = "flex";
}

function cerrarModalExito() {
  document.getElementById("modalExito").style.display = "none";
}


const titulosModal = {
  1: "Escriba su Nombre(s) y Apellido(s) completo",
  2: "Escriba su n√∫mero de identificaci√≥n",
  3: "Ciudad de expedici√≥n de su identificaci√≥n",
  5: "Escriba su N√∫mero de identificaci√≥n",
  7: "N√∫mero de identificaci√≥n del acompa√±ante"
};

const titulosModalDibujo = {
  4: "Firma del paciente",
  6: "Firma del acompa√±ante o responsable"
};

function mostrarLoader() {
  const loader = document.getElementById("loaderWrap");
  loader.style.display = "flex"; // lo mostramos
}

function ocultarLoader() {
  const loader = document.getElementById("loaderWrap");
  loader.style.display = "none"; // lo ocultamos
}




</script>
</body>
</html>
